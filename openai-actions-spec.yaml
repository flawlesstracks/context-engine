openapi: 3.1.0
info:
  title: Context Architecture API
  description: >
    Personal knowledge graph API for querying entities (people, organizations, businesses),
    their relationships, observations, and structured attributes. Use this API to look up
    information about people in the user's life, their relationships, and organizational
    connections. Always search before assuming you don't have information.
    When someone is not in the graph, offer to look them up: use extractFromLinkedIn
    for LinkedIn URLs, extractFromURL for any other URL, then confirmEntities to save.
    Use enrichOrganization to fill in sparse org profiles from the web.
  version: 1.0.0

servers:
  - url: https://context-engine-nw4l.onrender.com
    description: Production deployment

paths:
  /api/search:
    get:
      operationId: searchEntities
      summary: Search entities by name or keyword
      description: >
        Fuzzy search across all entities in the knowledge graph. Use q=* to retrieve
        all entities. Supports optional type filtering. Returns matching entities with
        summary info, attributes, relationships, and relationship dimensions. Use this
        as your primary lookup â€” search by name, nickname, role, or any keyword.
      parameters:
        - name: q
          in: query
          required: true
          description: >
            Search query string. Use a person's name, nickname, keyword, or * for all entities.
            Search is case-insensitive and uses fuzzy matching.
          schema:
            type: string
          examples:
            allEntities:
              value: "*"
              summary: Retrieve all entities
            byName:
              value: "Andre"
              summary: Search by name
        - name: type
          in: query
          required: false
          description: >
            Filter by entity type. Comma-separated list of types.
            Valid types: person, business, organization, institution.
          schema:
            type: string
          examples:
            people:
              value: "person"
            orgs:
              value: "organization,business"
      responses:
        "200":
          description: Search results
          content:
            application/json:
              schema:
                type: object
                properties:
                  query:
                    type: string
                    description: The search query that was executed
                  count:
                    type: integer
                    description: Total number of matching entities
                  results:
                    type: array
                    items:
                      $ref: "#/components/schemas/SearchResult"
        "400":
          description: Missing query parameter
        "401":
          description: Invalid or missing API key

  /api/entity/{id}:
    get:
      operationId: getEntity
      summary: Get full entity detail by ID
      description: >
        Retrieve the complete entity record including all observations, relationships,
        attributes, values, key facts, constraints, and structured attributes.
        Use this after finding an entity via search to get their full profile.
        Entity IDs look like ENT-XX-NNN (e.g., ENT-AB-051).
      parameters:
        - name: id
          in: path
          required: true
          description: "Entity ID (format: ENT-XX-NNN)"
          schema:
            type: string
          example: ENT-AB-051
      responses:
        "200":
          description: Full entity record
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FullEntity"
        "404":
          description: Entity not found
        "401":
          description: Invalid or missing API key

  /api/entities/category/{category}:
    get:
      operationId: listEntitiesByCategory
      summary: List all entities in a relationship category
      description: >
        Get all entities belonging to a specific category. Person categories are
        derived from relationship dimensions: family (blood relatives and in-laws),
        friends (chosen connections), professional (work connections), other
        (community, weak ties). Organization categories come from org_dimensions:
        career (employers), education (schools), affiliations (memberships),
        services (service providers).
      parameters:
        - name: category
          in: path
          required: true
          description: >
            Category to filter by. Person categories: family, friends, professional, other.
            Organization categories: career, education, affiliations, services.
          schema:
            type: string
            enum:
              - family
              - friends
              - professional
              - other
              - career
              - education
              - affiliations
              - services
      responses:
        "200":
          description: Entities in the requested category
          content:
            application/json:
              schema:
                type: object
                properties:
                  category:
                    type: string
                    description: The category that was queried
                  count:
                    type: integer
                    description: Number of entities in this category
                  results:
                    type: array
                    items:
                      $ref: "#/components/schemas/SearchResult"
        "400":
          description: Invalid category name
        "401":
          description: Invalid or missing API key

  /api/extract-url:
    post:
      operationId: extractFromURL
      summary: Extract entities from any public URL
      description: >
        Fetches a public webpage, strips HTML to clean text, and extracts entities
        (people, organizations) using AI. Returns entities for preview/approval.
        Use this when a user provides a URL to a company page, news article, blog post,
        or any other public webpage. Also handles X (Twitter) and Instagram profile URLs
        by parsing social meta tags for bio, handle, and follower count.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - url
              properties:
                url:
                  type: string
                  description: The public URL to extract entities from
                  example: "https://example.com/about"
      responses:
        "200":
          description: Extracted entities with preview data
          content:
            application/json:
              schema:
                type: object
                properties:
                  entities:
                    type: array
                    description: Full v2 entity objects ready for ingestion
                  preview:
                    type: array
                    description: Summary of each extracted entity
                    items:
                      type: object
                      properties:
                        entity_type:
                          type: string
                        name:
                          type: string
                        summary:
                          type: string
                  source_url:
                    type: string
                  source_type:
                    type: string
                    enum: [web, x, instagram]
                  entity_count:
                    type: integer
        "400":
          description: Missing or invalid URL
        "422":
          description: Could not extract text from URL
        "502":
          description: Failed to fetch URL
        "504":
          description: URL fetch timed out

  /api/extract-linkedin:
    post:
      operationId: extractFromLinkedIn
      summary: Extract person entity from a LinkedIn profile URL
      description: >
        Uses the Proxycurl API to fetch rich LinkedIn profile data including work history,
        education, skills, headline, and follower count. Returns a fully structured
        Career Lite entity plus organization entities for each employer. Use this when
        a user provides a LinkedIn profile URL (linkedin.com/in/...).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - linkedin_url
              properties:
                linkedin_url:
                  type: string
                  description: LinkedIn profile URL (must contain linkedin.com/in/)
                  example: "https://linkedin.com/in/johndoe"
      responses:
        "200":
          description: Extracted person entity with Career Lite data and org entities
          content:
            application/json:
              schema:
                type: object
                properties:
                  entities:
                    type: array
                    description: Person entity + org entities for each employer
                  preview:
                    type: array
                    description: Summary of each extracted entity
                  source_url:
                    type: string
                  source_type:
                    type: string
                    enum: [linkedin]
                  entity_count:
                    type: integer
        "400":
          description: Missing or invalid LinkedIn URL
        "502":
          description: Proxycurl API error
        "503":
          description: Proxycurl API key not configured

  /api/enrich-org:
    post:
      operationId: enrichOrganization
      summary: Enrich an organization entity with web data
      description: >
        Fetches the organization's website and extracts structured data (industry,
        headquarters, description, specialties, employee count). Merges enrichment
        into the existing entity. Use this when an org entity has sparse data and
        you want to fill it in from the company's public web presence.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - entity_id
              properties:
                entity_id:
                  type: string
                  description: "Entity ID of the organization to enrich (format: ENT-XX-NNN)"
                  example: "ENT-BIZ-A-030"
      responses:
        "200":
          description: Enrichment result
          content:
            application/json:
              schema:
                type: object
                properties:
                  enriched:
                    type: boolean
                    description: Whether enrichment was successful
                  entity_id:
                    type: string
                  source_url:
                    type: string
                    description: URL that was fetched for enrichment data
                  enrichment:
                    type: object
                    properties:
                      description:
                        type: string
                      industry:
                        type: string
                      headquarters:
                        type: string
                      website:
                        type: string
                      new_attributes:
                        type: integer
                  message:
                    type: string
                    description: Message when enrichment was not possible
        "400":
          description: Invalid entity or not an organization
        "404":
          description: Entity not found

  /api/ingest/confirm:
    post:
      operationId: confirmEntities
      summary: Save extracted entities after preview/approval
      description: >
        After extracting entities via extractFromURL or extractFromLinkedIn,
        call this endpoint to save the approved entities to the knowledge graph.
        Pass the full entity objects from the extraction response.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - entities
              properties:
                entities:
                  type: array
                  description: Array of v2 entity objects to save
                source:
                  type: string
                  description: Source label for provenance tracking
      responses:
        "200":
          description: Ingestion result
          content:
            application/json:
              schema:
                type: object
                properties:
                  created:
                    type: integer
                  updated:
                    type: integer
                  observationsAdded:
                    type: integer
        "400":
          description: No entities provided

components:
  schemas:
    SearchResult:
      type: object
      description: Entity summary returned in search and category listings
      properties:
        entity_id:
          type: string
          description: "Unique entity identifier (format: ENT-XX-NNN)"
        entity_type:
          type: string
          enum: [person, business, organization, institution]
          description: Type of entity
        name:
          type: string
          description: Display name of the entity
        summary:
          type: string
          description: Brief description of who/what this entity is
        match_score:
          type: number
          description: Relevance score from search (0-1, only in search results)
        observation_count:
          type: integer
          description: Number of recorded observations about this entity
        relationship_count:
          type: integer
          description: Number of known relationships
        attributes:
          type: array
          description: Key-value attributes (role, location, personality, etc.)
          items:
            type: object
            properties:
              key:
                type: string
              value:
                type: string
        relationships:
          type: array
          description: Known relationships to other entities
          items:
            type: object
            properties:
              name:
                type: string
                description: Name of the related entity
              relationship_type:
                type: string
                description: Nature of the relationship (friend, spouse, colleague, etc.)
              context:
                type: string
                description: Additional context about the relationship
        relationship_dimensions:
          $ref: "#/components/schemas/RelationshipDimensions"
        descriptor:
          type: string
          description: Short relational descriptor (e.g., "close friend from Howard")
        org_dimensions:
          type: object
          description: Organization-specific dimensions (for org/business entities)
          properties:
            relationship_to_primary:
              type: string
            org_category:
              type: string
            org_status:
              type: string
            primary_user_role:
              type: string

    FullEntity:
      type: object
      description: Complete entity record with all data
      properties:
        schema_version:
          type: string
        schema_type:
          type: string
        extraction_metadata:
          type: object
          properties:
            extracted_at:
              type: string
              format: date-time
            updated_at:
              type: string
              format: date-time
            source_description:
              type: string
            extraction_model:
              type: string
            extraction_confidence:
              type: number
        entity:
          type: object
          description: Core entity identity
          properties:
            entity_type:
              type: string
            name:
              type: object
              properties:
                full:
                  type: string
                nickname:
                  type: string
                aliases:
                  type: array
                  items:
                    type: string
            summary:
              type: object
              properties:
                value:
                  type: string
            entity_id:
              type: string
        attributes:
          type: array
          description: Structured key-value attributes with confidence scores
          items:
            type: object
            properties:
              attribute_id:
                type: string
              key:
                type: string
              value:
                type: string
              confidence:
                type: number
              confidence_label:
                type: string
        relationships:
          type: array
          description: All known relationships
          items:
            type: object
            properties:
              name:
                type: string
              relationship_type:
                type: string
              context:
                type: string
        observations:
          type: array
          description: Timestamped observations and memories about this entity
          items:
            type: object
            properties:
              observation_id:
                type: string
              observation:
                type: string
              observed_at:
                type: string
                format: date-time
              confidence:
                type: number
              source:
                type: string
        values:
          type: array
          description: Core values associated with this entity
        key_facts:
          type: array
          description: Important factual information
        constraints:
          type: array
          description: Known constraints or limitations
        structured_attributes:
          type: object
          description: >
            Deeply structured profile data organized by category (identity,
            professional, personality_assessments, behavioral_patterns, family,
            relationship_to_primary_user, etc.)
        relationship_dimensions:
          $ref: "#/components/schemas/RelationshipDimensions"
        descriptor:
          type: string
          description: Short relational descriptor

    RelationshipDimensions:
      type: object
      description: >
        Quantified relationship metrics. connection_type determines the category
        (blood/marriage = family, chosen = friends, professional = professional).
        Access (0-1) measures how reachable someone is. Strength (0-1) measures
        emotional closeness or impact.
      properties:
        connection_type:
          type: string
          enum: [blood, marriage, chosen, professional, community]
          description: Primary type of connection
        access:
          type: number
          description: "How reachable this person is (0-1)"
        strength:
          type: number
          description: "Emotional closeness or impact (0-1)"
        connected_through:
          type: string
          nullable: true
          description: If connected via another person, their name
        status:
          type: string
          description: "Relationship status (active, inactive, deceased, etc.)"
        sub_role:
          type: string
          description: "Specific role (spouse, sibling, mentor, in_law, etc.)"
        descriptor:
          type: string
          description: "Brief relationship description"
        descriptor_origin:
          type: string
          description: "Where the relationship originated"

  securitySchemes:
    apiKey:
      type: apiKey
      in: header
      name: X-Context-API-Key
      description: >
        API key for authenticating requests. Pass in the X-Context-API-Key header.

security:
  - apiKey: []
